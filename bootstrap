#!/usr/bin/env bash

########################################################################
# Regenerate auto-generated files (e.g. configure)
#
# If the -s option is given, save the autogenerated scripts in
# $SAGE_ROOT/upstream/configure-$CONFVERSION.tar.gz where CONFVERSION
# is the version number stored in
# build/pkgs/configure/package-version.txt
#
# If optional argument -i is given, then automatically increment the
# version number
########################################################################

set -e

# Either run this script from SAGE_ROOT or make sure that SAGE_ROOT
# is set
test -z "$SAGE_ROOT" || cd "$SAGE_ROOT"

PKG=build/pkgs/configure
MAKE="${MAKE:-make}"
CONFVERSION=`cat $PKG/package-version.txt`

bootstrap () {
    $MAKE bootstrap-clean      # Start cleanly
    mkdir config               # deleted by bootstrap-clean
    aclocal -I m4
    automake --add-missing --copy build/Makefile-auto
    autoconf
}


save () {
    # Create configure tarball
    CONFBALL="upstream/configure-$CONFVERSION.tar.gz"
    echo "Creating $CONFBALL..."
    mkdir -p upstream
    tar --transform 's,^,autogenerated/,' -z -c -f "$CONFBALL" \
        configure config/* build/Makefile-auto.in
    
    # Update version number
    echo "$CONFVERSION" >$PKG/package-version.txt
    
    # Compute checksum
    src/bin/sage-fix-pkg-checksums "$CONFBALL"
}


usage () {
    echo >&2 "Usage: bootstrap [-i] [-s] [-h]"
}


# Parse options
SAVE=
while getopts "sih" OPTION
do
     case "$OPTION" in
         s)
             SAVE=yes
             ;;
         i)
             CONFVERSION=$(( CONFVERSION + 1 ))
             ;;
         h)
             usage
             exit
             ;;
         ?)
             usage
             exit 2
             ;;
     esac
done

bootstrap
if [ -n "$SAVE" ]; then
    save
fi
