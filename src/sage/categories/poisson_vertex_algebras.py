r"""
Poisson Vertex Algebras.

Let `R` be a commutative ring. A *super Poisson vertex algebra* over `R`
is a tuple `(P, T, \mathbb{1}, \{\cdot_\lambda \cdot\}, \cdot)` such that:

- `(P,\mathbb{1}, \cdot)` is a unital super commutative and associative
  algebra over `R`.
- `(P, T, \{ \cdot_\lambda \cdot \})` is a super
  :mod:`Lie conformal algebra<sage.categories.lie_conformal_algebras>`
  over `R`.
- `T` is an even derivation of the commutative product `\cdot`.
- The following *Leibniz* identity holds in `P[\lambda]`:

    .. MATH::

        \{a_\lambda b\cdot c\} = \{a_\lambda b\}\cdot c  + (-1)^{p(a)p(b)}
        b \cdot \{a_\lambda c\}, \qquad a,b,c \in P

where `p(a)` is `0` if `a` is *even* and `1` if it is *odd*

Given a :mod:`super vertex algebra<sage.categories.vertex_algebras>` `V` the
associated graded `P = \mathrm{gr}^F V` with respect to the
:mod:`Li
filtration<sage.algebras.poisson_vertex_algebras.vertex_algebra_classical_limit>`
is canonically a super Poisson vertex algebra. The operations are defined by:

.. MATH::

    \sigma_p(a) \cdot \sigma_q(b) = \sigma_{p+q} (a_{(-1)} b), \qquad
    \{\sigma_p(a)_\lambda \sigma_q(b)\} = \sum_{j \geq 0}
    \frac{\lambda^j}{j!} \sigma_{p+q-j} \bigl( a_{(j)} b \bigr), \qquad
    T \sigma_p a = \sigma_{p+1} Ta

where `\sigma_p` is the principal symbol map. This algebra is graded: the
multiplication and `\lambda` bracket are of degree `0`. This graded super
Poisson vertex algebra is known as the
:meth:`classical
limit<sage.categories.vertex_algebras.VertexAlgebras.ParentMethods.classical_limit>`
or the *singular support* of `V`. It's degree `0` part

.. MATH::

   R_V = \mathrm{gr}^F_0 V = V/C_2(V) = V/V_{(-2)}V,

is a super Poisson algebra known as *Zhu's* `C_2` *quotient of* `V`. Its
spectrum is known as the *associated scheme* of `V`.

When `V` is also `H`-graded its classical limit is
bigraded. We call this extra grading the *conformal weight* grading. With
respect to the conformal weight grading, the multiplication is of degree `0`
while the `\lambda` bracket is of degree `-1`.

There is another super Poisson vertex algebra canonically associated to any
super vertex algebra. This is the
:meth:`arc algebra<sage.categories.vertex_algebras.VertexAlgebras.ParentMethods.arc_algebra>`
of `V`. It is the super commutative differential algebra `JR_V` freely generated
by `R_V`, in other words: the algebra of functions on the arc space of the
associated scheme of `V`. It has a canonical super Poisson vertex algebra
structure and by the universal property there exists a canonical surjection

.. MATH::

   JR_V \twoheadrightarrow \mathrm{gr}^F V

of super Poisson vertex algebras.

EXAMPLES:

- The classical limit of the universal Virasoro vertex algebra is the
  polynomial algebra in infinitely many generators. `R[L_{-2},L_{-3},\ldots]`
  The generator `L_{-n}` is in Li filtration degree `n-2` and conformal
  weight degree `n`. As an `R[T]` module it is freely generated by `L_{-2}`.
  The `\lambda` bracket vanishes on `P`.

- The classical limit of the universal affine vertex algebra
  `V^k(\mathfrak{g})` associated to a finite dimensional Lie algebra
  `\mathfrak{g}` is also a commutative algebra with infinitely many
  generators: `P = Sym^* t^{-1}\mathfrak{g}[t^{-1}]`. The generators
  `t^{-n-1}a` for `n \geq 0` and `a \in \mathfrak{g}` are in bidegree
  `(n,n)`.  As an `R[T]`-module it
  is finitely generated by `t^{-1} \mathfrak{g}`, the action of `T` is given
  by `\frac{d}{d t}`. The `\lambda` bracket among generators is given by

  .. MATH::

        \left\{t^{-1}a_\lambda t^{-1}b \right\} = t^{-1}[a,b]

.. SEEALSO::

    :mod:`sage.algebras.poisson_vertex_algebras.poisson_vertex_algebra`

AUTHORS:

- Reimundo Heluani (2019-10-09): Initial implementation.
"""

#******************************************************************************
#       Copyright (C) 2019 Reimundo Heluani <heluani@potuz.net>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#                  http://www.gnu.org/licenses/
#*****************************************************************************
from sage.categories.category_types import Category_over_base_ring
from sage.categories.category_with_axiom import CategoryWithAxiom_over_base_ring
from sage.misc.cachefunc import cached_method
from .super_modules import SuperModulesCategory
from .proto_poisson_vertex_algebras import ProtoPoissonVertexAlgebras
from .lie_conformal_algebras import LieConformalAlgebras
from .graded_poisson_vertex_algebras import GradedPoissonVertexAlgebrasCategory
from sage.misc.lazy_import import LazyImport

class PoissonVertexAlgebras(Category_over_base_ring):
    """
    The category of Poisson vertex algebras
    """

    @cached_method
    def super_categories(self):
        """
        The super categories of this category

        EXAMPLES::

            sage: C = PoissonVertexAlgebras(QQ); C
            Category of Poisson vertex algebras over Rational Field
            sage: C.super_categories()
            [Category of proto Poisson vertex algebras over Rational Field,
             Category of Lie conformal algebras over Rational Field]
            sage: C.Graded()
            Category of H-graded Poisson vertex algebras over Rational Field
            sage: C.Graded().super_categories()
            [Category of H-graded proto Poisson vertex algebras over Rational Field,
             Category of Poisson vertex algebras over Rational Field,
             Category of H-graded Lie conformal algebras over Rational Field]
        """
        return [ProtoPoissonVertexAlgebras(self.base_ring()),
                LieConformalAlgebras(self.base_ring())]

    def example(self):
        """
        An example of a parent in this category.

        EXAMPLES::

            sage: V = vertex_algebras.Virasoro(QQ,1)
            sage: P = V.classical_limit(); P
            The classical limit of The Virasoro vertex algebra of central charge 1 over Rational Field
        """
    def _repr_object_names(self):
        """
        The names of objects of this category.

        EXAMPLES::

            sage: PoissonVertexAlgebras(QQ)
            Category of Poisson vertex algebras over Rational Field
        """
        return "Poisson vertex algebras over {}".format(self.base_ring())

    class FinitelyGeneratedAsDifferentialAlgebra(CategoryWithAxiom_over_base_ring):
        """
        The category of finitely generated Poisson vertex algebras.
        """
        class WithBasis(CategoryWithAxiom_over_base_ring):
            """
            The category of finitely generated Poisson vertex algebras
            with basis.

            EXAMPLES::

                sage: PoissonVertexAlgebras(AA).WithBasis().FinitelyGenerated()
                Category of finitely generated Poisson vertex algebras with basis over Algebraic Real Field
            """
            class Graded(GradedPoissonVertexAlgebrasCategory):
                """
                The category of H-graded finitely generated Poisson
                vertex algebras with basis.
                """
        
        class Graded(GradedPoissonVertexAlgebrasCategory):
            """
            The category of H-graded finitely generated Poisson vertex algebras
            """


    class WithBasis(CategoryWithAxiom_over_base_ring):
        """
        The category of Poisson vertex algebras with a preferred basis.

        EXAMPLES::

            sage: PoissonVertexAlgebras(AA).WithBasis()
            Category of Poisson vertex algebras with basis over Algebraic Real Field
        """
        class Graded(GradedPoissonVertexAlgebrasCategory):
            """
            The category of H-graded Poisson vertex algebras with basis.
            """

    Graded = LazyImport("sage.categories.graded_poisson_vertex_algebras",
                        "GradedPoissonVertexAlgebras", "Graded")

    class Super(SuperModulesCategory):
        """
        The category of super Poisson vertex algebras.
        """

        def extra_super_categories(self):
            """
            The extra super categories of this category.

            EXAMPLES::

                sage: C = PoissonVertexAlgebras(QQ).Super()
                sage: C.super_categories()
                [Category of super algebras over Rational Field,
                 Category of proto Poisson vertex algebras over Rational Field,
                 Category of super Lie conformal algebras over Rational Field]
            """
            return [ProtoPoissonVertexAlgebras(self.base_ring()),
                    LieConformalAlgebras(self.base_ring()).Super()]

        def example(self):
            """
            An example of a parent in this category.

            EXAMPLES::

                sage: V = vertex_algebras.NeveuSchwarz(QQ,1)
                sage: P = V.classical_limit(); P
                The classical limit of The Neveu-Schwarz super vertex algebra of central charge 1 over Rational Field
            """

        class WithBasis(CategoryWithAxiom_over_base_ring):
            """
            The subcategory of super Poisson vertex algebras with basis.

            EXAMPLES::

                sage: PoissonVertexAlgebras(QQbar).Super().WithBasis()
                Category of super Poisson vertex algebras with basis over Algebraic Field
            """

        class FinitelyGeneratedAsDifferentialAlgebra(
                                            CategoryWithAxiom_over_base_ring):
            """
            The subcategory of finitely generated super Poisson vertex
            algebras.

            EXAMPLES::

                sage: PoissonVertexAlgebras(QQbar).Super().FinitelyGenerated()
                Category of finitely generated super Poisson vertex algebras over Algebraic Field
            """

            class WithBasis(CategoryWithAxiom_over_base_ring):
                """
                The subcategory of finitely generated super Poisson
                vertex algebras with basis.

                EXAMPLES::

                    sage: PoissonVertexAlgebras(QQbar).Super().FinitelyGenerated().WithBasis()
                    Category of finitely generated super Poisson vertex algebras with basis over Algebraic Field
                """

        class Graded(GradedPoissonVertexAlgebrasCategory):
            """
            The category of H-graded super Poisson vertex algebras.
            """
