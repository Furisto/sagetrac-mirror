#!/usr/bin/env bash


set -e

[ -n "${SAGE_ROOT}" ] || SAGE_ROOT="$(readlink -f $(dirname ${0})/../../../)"


# Set the version and its download URL.
VERSION=1.5.0
DOWNLOAD_URL="https://pypi.python.org/packages/source/m/matplotlib/matplotlib-${VERSION}.tar.gz"

# fetch and unpack latest version
tar xzf <( curl -L ${DOWNLOAD_URL} )

# fetch and add ipe backend
curl -L "https://github.com/otfried/ipe-tools/raw/master/matplotlib/backend_ipe.py" -o matplotlib-${VERSION}/lib/matplotlib/backends/backend_ipe.py


# remove test images
rm -rf matplotlib-${VERSION}/lib/matplotlib/tests/baseline_images/*


# repack and cleanup temporary directory
tar cjf "$SAGE_ROOT/upstream/matplotlib-${VERSION}.tar.bz2" matplotlib-${VERSION}
rm -rf matplotlib-${VERSION}


# update package info
echo "${VERSION}" > "${SAGE_ROOT}/build/pkgs/matplotlib/package-version.txt"
"$SAGE_ROOT"/sage -sh 'sage-fix-pkg-checksums'

