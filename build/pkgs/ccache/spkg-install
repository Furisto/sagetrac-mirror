die () {
    echo >&2 "$@"
    exit 1
}

[ -n "$SAGE_LOCAL" ] || die "SAGE_LOCAL undefined, maybe run \`sage -sh\`?"

cd src

export CPPFLAGS="-I$SAGE_LOCAL/include $CPPFLAGS"
./configure --prefix="$SAGE_LOCAL" ||
    die "configuring ccache failed"

$MAKE || die "building ccache failed"

$MAKE install DESTDIR="$SAGE_INST_TEMP" || die "installing ccache failed"


set -e

PREFIX="$SAGE_INST_TEMP$SAGE_LOCAL"
mkdir -p "$PREFIX/libexec/ccache"
ln -sf ../../bin/ccache "$PREFIX/libexec/ccache/cc"
ln -sf ../../bin/ccache "$PREFIX/libexec/ccache/c++"
ln -sf ../../bin/ccache "$PREFIX/libexec/ccache/gcc"
ln -sf ../../bin/ccache "$PREFIX/libexec/ccache/g++"
ln -sf ../../bin/ccache "$PREFIX/libexec/ccache/clang"
ln -sf ../../bin/ccache "$PREFIX/libexec/ccache/clang++"

# Copy a reasonable default configuration for Sage
# (cache size of 4G and compression enabled)
cp -p ../ccache.conf "$PREFIX/etc"
