#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

cp sage_tdlib.cpp src/src/
cp sage_tdlib.hpp src/src/

cd src

./configure --prefix="$SAGE_LOCAL" && $MAKE

if [ $? -ne 0 ]; then
    echo >&2 "Failed to compile tdlib"
    exit 1
fi

rm -rf "$SAGE_LOCAL/include/tdlib/"
mkdir "$SAGE_LOCAL/include/tdlib/"
cp src/sage_tdlib.hpp "$SAGE_LOCAL/include/tdlib/"

if [ "$UNAME" = "Darwin" ]; then
    cp -f ./.libs/libtd.dylib "$SAGE_LOCAL/lib/libtd.dylib"
elif [ "$UNAME" = "CYGWIN" ]; then
    cp -f ./.libs/libtd.so "$SAGE_LOCAL/lib/libtd.dll"
fi

# Copy this in all cases, in any case it doesn't hurt.
cp -f ./.libs/libtd.so "$SAGE_LOCAL/lib/libtd.so"
cp -f ./.libs/libtd.so.0 "$SAGE_LOCAL/lib/libtd.so.0"
