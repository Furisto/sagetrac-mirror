#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

cp sage_tdlib.cpp src/
cp sage_tdlib.hpp src/
cp configure.ac src/
cp Makefile.am src/
cp autogen.sh src/

cd src

sh autogen.sh

./configure --prefix="$SAGE_LOCAL" && $MAKE

if [ $? -ne 0 ]; then
    echo >&2 "Failed to compile tdlib"
    exit 1
fi

rm -rf "$SAGE_LOCAL/include/tdlib/"
mkdir "$SAGE_LOCAL/include/tdlib/"
cp *.hpp "$SAGE_LOCAL/include/tdlib/"

if [ "$UNAME" = "Darwin" ]; then
    cp -f ./.libs/libtd.dylib "$SAGE_LOCAL/lib/libtd.dylib"
elif [ "$UNAME" = "CYGWIN" ]; then
    cp -f ./.libs/libtd.so "$SAGE_LOCAL/lib/libtd.dll"
fi

# Copy this in all cases, in any case it doesn't hurt.
cp -f ./.libs/libtd.so "$SAGE_LOCAL/lib/libtd.so"
