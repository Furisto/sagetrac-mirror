#!/usr/bin/env sage-dist-make

all: install

COMMONMK?=spkg.mk
include $(COMMONMK)

###############################################################################
# Set up environment variables:
###############################################################################
# FIXME, don't read random files!
LD_CBLAS=$(shell cat $(SAGE_PREFIX)/share/cblas_config 2>/dev/null)

# FIXME: why hardcode LDFLAGS?
# and: why isn't -L$(SAGE_PREFIX)/lib part of dist env?
LDFLAGS+=-L$(SAGE_PREFIX)/lib $(LD_CBLAS)

CFLAGS+=-g -fPIC
CXXFLAGS+=-g -fPIC

# Some systems have problems when parts of LinBox are compiled with
# the commentator enabled and other parts with the commentator
# disabled.  Therefore, disable it always.
CPPFLAGS+=-DDISABLE_COMMENTATOR

ifeq ($(SAGE64),yes)
    CFLAG64?=-m64
	 CFLAGS+=$(CFLAG64)
	 CXXFLAGS+=$(CFLAG64)
	 CPPFLAGS+=$(CFLAG64)
	 LDFLAGS+=$(CFLAG64)
endif


###############################################################################
# Configure, build and install LinBox:
###############################################################################

configure: patch-stamp
	cd src;\
	export CFLAGS=$(CFLAGS); \
	./configure --prefix="$(SAGE_PREFIX)" --libdir="$(SAGE_PREFIX)/lib" \
	            --with-default="$(SAGE_PREFIX)" \
	            --enable-sage --enable-optimization --disable-static \
	            LDFLAGS="$(LDFLAGS)" \
	            CPPFLAGS="$(CPPFLAGS)" \
	            CXXFLAGS="$(CXXFLAGS)" \
	            CFLAGS="$(CFLAGS)"

build: configure
	$(MAKE) -Csrc

install: build
	$(MAKE) -Csrc install INSTALL="$(SAGE_INSTALL)"


