#!/usr/bin/env bash

# Execute this script in $SAGE_ROOT

cd build/pkgs/meataxe
if [ $? -ne 0 ]; then
    echo >&2 "Error accessing the meataxe package directory"
    exit 1
fi

export COMMIT=$(cat package-version.txt | cut -d'.' -f4)

echo "Creating source ball for meataxe version 2.5.0 at commit" $COMMIT

git clone https://github.com/momtx/meataxe.git
if [ $? -ne 0 ]; then
    echo >&2 "Error cloning upstream repository."
    exit 1
fi
cd meataxe
git checkout -b package $COMMIT
if [ $? -ne 0 ]; then
    echo >&2 "Error checking out commit."
    exit 1
fi

for patch in ../patches/src/*.patch; do
    [ -r "$patch" ] || continue  # Skip non-existing or non-readable patches
    echo "Applying $patch"
    git apply "$patch"
    if [ $? -ne 0 ]; then
        echo >&2 "Error applying '$patch'"
        return 1
    fi
done

sed -i 's/-SNAPSHOT/.'$COMMIT'/' Makefile
if [ $? -ne 0 ]; then
    echo >&2 "Error writing version number into the makefile."
    exit 1
fi
make dist
if [ $? -ne 0 ]; then
    echo >&2 "Error making source ball."
    exit 1
fi

cd ../../../..
echo "Moving source ball into Sage's DISTFILES directory"
./sage --sh -c 'mv build/pkgs/meataxe/meataxe/meataxe-2.5.0.$COMMIT.tar.gz "$SAGE_DISTFILES"'
if [ $? -ne 0 ]; then
    echo >&2 "Error moving upstream tarball into the distfiles directory."
    exit 1
fi

rm -rf build/pkgs/meataxe/meataxe
exit 0
