#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ]; then
    echo >&2 "SAGE_LOCAL undefined ... exiting"
    echo >&2 "Maybe run 'sage --sh'?"
    exit 1
fi

cd src

for patch in ../patches/*.patch; do
    [ -r "$patch" ] || continue  # Skip non-existing or non-readable patches
    echo "Applying $patch"
    patch -p1 <"$patch"
    if [ $? -ne 0 ]; then
        echo >&2 "Error applying '$patch'"
        exit 1
    fi
done

## The following *could* be put into Makefile.conf

# Default compiler flags
CFLAGS1="-std=gnu99 -O3 -Wall -fPIC"
# Field size up to GF(256)
ZZZ=0
# In principle, one should uncomment for field sizes up to GF(2^16).
# But upstream doesn't provide the required sources.
#export ZZZ=1

# The following is just to make MeatAxe's Makefile happy
touch Makefile.conf

## Install! To work around a bug in the test suite, we test
## single-threaded. And since we don't want the MeatAxe
## multiplication tables to reside in SAGE_LOCAL/lib, but
## MeatAxe's test suite is putting them there, we need to
## remove them after testing.

if [ "x$SAGE_CHECK" = xyes ]; then
    $MAKE MTXROOT=$SAGE_LOCAL V=1 CFLAGS1="$CFLAGS1" V=1 
    $MAKE MTXROOT=$SAGE_LOCAL -j1 test
    rm $SAGE_LOCAL/lib/p*.zzz
else
    $MAKE MTXROOT=$SAGE_LOCAL CFLAGS1="$CFLAGS1" V=1
fi

if [ $? -ne 0 ]; then
    echo >&2 "Error installing MeatAxe."
    exit 1
fi

# Are we supposed to install the documentation?
if [ "x$SAGE_SPKG_INSTALL_DOCS" = xyes ] ; then
    mkdir -p $SAGE_ROOT/local/share/doc/meataxe/
    cp -r doc/* $SAGE_ROOT/local/share/doc/meataxe/
    if [ $? -ne 0 ]; then
        echo "Error copying documentation."
        exit 1
    else
        echo "The documentation can be found in $SAGE_ROOT/local/share/doc/meataxe/"
    fi
fi
