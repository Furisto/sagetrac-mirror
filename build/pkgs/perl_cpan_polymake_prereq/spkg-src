#!/bin/bash
# Invoke from SAGE_ROOT.
# creates the tarball and updates the package.
# Needs Perl package CPAN::Mirror::Tiny.
set -e

if [ ! -x sage ]; then
    echo "Invoke this script from SAGE_ROOT"
    exit 1
fi

SAGE_ROOT=`pwd`

mkdir -p upstream/perl_cpan_polymake_prereq
cd upstream/perl_cpan_polymake_prereq

TEMP_PERL_LOCAL_LIB_ROOT=`pwd`/temp-perl-local-lib
PARTIAL_CPAN_MIRROR=sagepan
ABS_PARTIAL_CPAN_MIRROR=`pwd`/$PARTIAL_CPAN_MIRROR

# Get the self-contained cpanm Perl script
curl -L https://cpanmin.us/ -o cpanm
chmod +x cpanm
CPANM=`pwd`/cpanm

# Make sure we are not influenced by local::lib stuff
SAVE_PERL5LIB=$PERL5LIB
unset PERL5LIB
unset PERL_LOCAL_LIB_ROOT
unset PERL_MB_OPT
unset PERL_MM_OPT
# No options for cpanm
unset PERL_CPANM_OPT
# Make sure we are not influenced by stuff in ~/.cpanm
export PERL_CPANM_HOME=`pwd`/cpanm_home

for stage in $SAGE_ROOT/build/pkgs/perl_cpan_polymake_prereq/stage* ; do
    (cd $stage && $CPANM --verbose --local-lib-contained $TEMP_PERL_LOCAL_LIB_ROOT --save-dists $ABS_PARTIAL_CPAN_MIRROR --installdeps . )
done

export PERL5LIB=$SAVE_PERL5LIB
cpan-mirror-tiny -b $PARTIAL_CPAN_MIRROR gen-index

# https://stackoverflow.com/questions/5566982/cpanminiinject-doesnt-update-03modlist-data-gz
cat > $PARTIAL_CPAN_MIRROR/modules/03modlist.data <<'EOF'
package CPAN::Modulelist;
sub data { my $result = {} }
$CPAN::Modulelist::cols = [];
$CPAN::Modulelist::data = [];
EOF
rm -f $PARTIAL_CPAN_MIRROR/modules/03modlist.data.gz
gzip $PARTIAL_CPAN_MIRROR/modules/03modlist.data

VERSION=`date +%Y-%m-%d`
tar cfz $SAGE_ROOT/upstream/perl_cpan_polymake_prereq-$VERSION.tar.gz --exclude=.cache cpanm $PARTIAL_CPAN_MIRROR

$SAGE_ROOT/sage -package update perl_cpan_polymake_prereq $VERSION
