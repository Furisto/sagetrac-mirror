###########################################
## Python
###########################################

# It is best to unset these environment variables, as they might confuse
# the Python installer.
unset PYTHONHOME
unset PYTHONPATH

# Prevent use of the system hg and svn as it might make the installation fail
export HAS_HG=no
export SVNVERSION=no

CUR="$(pwd)"

cd src


# Remove old libraries
rm -f "$SAGE_LOCAL"/lib/libpython3*

# Running 'make install' in parallel is a bad idea, so we use
# only 1 job.
# The "-i" option to ignore errors is crucial, especially in the
# case of upgrades.
sdh_make_install -i -j1

# Handle the 2to3 script appropriately; see the spkg-install for python2
# for more details. This will remove the 2to3 installed by Python 3.  If we
# are not installing into a temporary location (e.g. $SAGE_DESTDIR is
# somehow empty) then restore the symlink from 2to3 to 2to3-2.7 if
# possible.
cd "${SAGE_DESTDIR}${SAGE_LOCAL}/bin"
rm -f 2to3
if [ -f 2to3-2.7 ]; then
    ln -s 2to3-2.7 2to3
fi
cd "$CUR/src"

echo "Installing valgrind suppression file..."
mkdir -p "${SAGE_DESTDIR}${SAGE_EXTCODE}/valgrind"
cp Misc/valgrind-python.supp "$SAGE_DESTDIR/$SAGE_EXTCODE/valgrind/python3.supp" || \
    sdh_die "Error installing valgrind suppression file."

if [ "$UNAME" = "Linux" ]; then
    export LD_LIBRARY_PATH="."
elif [ "$UNAME" = "Darwin" ]; then
    export DYLD_LIBRARY_PATH="."
fi

# When building on a case-insensitive filesystem (on any OS, not just Windows)
# the Python executable is output to the build directory as 'python.exe'
if [ -f "python.exe" ]; then
    PYTHON="./python.exe"
else
    PYTHON="./python"
fi

PYTHON_VERSION=$($PYTHON -c 'import sys; print("%d.%d" % sys.version_info[:2])')
PYTHON_ABIFLAGS=$($PYTHON -c 'import sys; print(sys.abiflags)')

# On OS X with XCode 4, the presence of
# $SAGE_LOCAL/lib/python3.x/config/libpython3.x.a causes problems with
# GiNaC -- see #11967.  It is easiest to test the version of OS X; we
# delete this file if using OS X 10.6 or later (so `uname -r` returns
# x.y.z with x >= 10).
if [ "$UNAME" = "Darwin" ] && \
    [ `uname -r | cut '-d.' -f1` -gt 9 ]; then
    rm -f "${SAGE_DESTDIR}${SAGE_LOCAL}/lib/python$PYTHON_VERSION/config/libpython${PYTHON_VERSION}.a"
elif [ "$UNAME" = "CYGWIN" ]; then
    # See http://trac.sagemath.org/ticket/20437
    ln -sf "python$PYTHON_VERSION/config-${PYTHON_VERSION}${PYTHON_ABIFLAGS}/libpython${PYTHON_VERSION}${PYTHON_ABIFLAGS}.dll.a" \
        "${SAGE_DESTDIR}${SAGE_LOCAL}/lib/libpython${PYTHON_VERSION}.dll.a"
fi
