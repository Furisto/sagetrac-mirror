if [ "$SAGE_ROOT" = "" ]; then
   echo "SAGE_ROOT undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

SPKGDIR=`pwd`
echo "Temporary package directory: $SPKGDIR"

# Patches.  Comment out this section if there are none.
if [ ! -d "$SPKGDIR"/patches ]; then
   echo "Error finding patches directory. Exiting."
   exit 1
fi

cd "$SPKGDIR/src"

# pure javascript for web and java applet in separate /share/jsmol directory.
mkdir -p "$SAGE_DESTDIR$SAGE_SHARE/jsmol"
echo "Installing the JSmol files..."
cp -r jsmol/* "$SAGE_DESTDIR$SAGE_SHARE/jsmol"
if [ $? -ne 0 ]; then
   echo "Error installing jmol files. Exiting."
   exit 1
fi

# "install" the Jmol files...
mkdir -p "$SAGE_DESTDIR$SAGE_SHARE/jmol"
# Jsmol is stuck inside the jmol directory, remove
rm -r "jsmol"
if [ $? -ne 0 ]; then
   echo "Error removing the contained jsmol files. Exiting."
   exit 1
fi

echo "Installing the Jmol files..."
cp -r * "$SAGE_DESTDIR$SAGE_SHARE"/jmol/
if [ $? -ne 0 ]; then
   echo "Error installing jmol files. Exiting."
   exit 1
fi

echo "Install the Jmol launcher to bin/..."
SAGE_BIN="$SAGE_DESTDIR$SAGE_LOCAL/bin"
mkdir -p "$SAGE_BIN"
cp -f jmol "$SAGE_BIN"/jmol && chmod ugo+x "$SAGE_BIN"/jmol
if [ $? -ne 0 ]; then
   echo "Error installing the jmol launcher. Exiting."
   exit 1
fi

echo "Installing applet web directory"
mkdir -p "$SAGE_DESTDIR$SAGE_SHARE"/jmol/appletweb
cp -r "$SPKGDIR"/patches/appletweb/* "$SAGE_DESTDIR$SAGE_SHARE"/jmol/appletweb/
if [ $? -ne 0 ]; then
   echo "Error installing the applet web directory"
   exit 1
fi

if [ $? -ne 0 ]; then
   echo "Error installing Jmol."
   exit 1
else
   echo "New Jmol installed successfully."
fi
