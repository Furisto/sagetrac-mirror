#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ]; then
    echo >&2 "Error: SAGE_LOCAL undefined - exiting..."
    echo >&2 "Maybe run 'sage -sh'?"
    exit 1
fi

cd src

# Apply patches (if any):
for patch in ../patches/*.patch; do
    [ -r "$patch" ] || continue  # Skip non-existing or non-readable patches
    patch -p1 <"$patch"
    if [ $? -ne 0 ]; then
        echo >&2 "Error applying '$patch'"
        exit 1
    fi
done

# Numpy/SciPy ships its own "improved" distutils.
# In particular, if one of these environment variables is defined:
#
#  F77, F90, LDSHARED, LD, AR, RANLIB,
#  F77FLAGS, F90FLAGS, FREEFLAGS, FOPT, FARCH,
#  FDEBUG, FFLAGS, LDFLAGS, ARFLAGS
#
# then it will be used as is (even if empty),
# potentially omitting necessary flags.
# E.g., if LDFALGS is set, but does not contain "-shared",
# linking of shared modules will fail.
#
# So either we unset all of the above which can be harmful,
# or trust that the user won't break everything.
# The most critical parts are:
# - compile objects with -fPIC or equivalent,
# - link them with -shared.

# Make sure that the fortran objects are compiled with -fPIC
if [ -n "${FFLAGS+set}" ]; then
    export FFLAGS="-fPIC $FFLAGS"
fi
if [ -n "${FCFLAGS+set}" ]; then
    export FCFLAGS="-fPIC $FCFLAGS"
fi

# Make sure to link with the shared flag on most platforms
if [ -n "${LDFLAGS+set}" ]; then
    if [ "$UNAME" != "Darwin" ]; then
        export LDFLAGS="-bundle -undefined dynamic_lookup $LDFLAGS"
        export CPPFLAGS="-D__ACCELERATE__ $CPPFLAGS"
    else
        export LDFLAGS="-shared $LDFLAGS"
    fi
fi

# This avoids problems on some systems -- until we officially
# support umfpack (which we will likely do, since cvxopt I think includes it):
export UMFPACK="None"
# See http://projects.scipy.org/pipermail/scipy-user/2006-July/008661.html
# (Currently SWIG gets invoked by scipy when building the umfpack interface,
# which is bad.)

python setup.py build
if [ $? -ne 0 ]; then
    echo >&2 "Error building scipy."
    exit 1
fi

# Remove previous installation (if any):
rm -rf "$SAGE_LOCAL"/lib/python/site-packages/scipy

python setup.py install
if [ $? -ne 0 ]; then
    echo >&2 "Error installing scipy."
    exit 1
fi
